name: Deploy to Dev

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'

env:
  AWS_REGION: ap-northeast-2
  ENVIRONMENT: dev
  STACK_NAME: profile-photo-ai-dev

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov
      
      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          python -m pytest tests/test_lambda_direct.py -v --cov=backend/lambda --cov-report=term-missing

  deploy-backend:
    name: Deploy Backend (SAM)
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://dev.aigyeom.com
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install AWS SAM CLI
        run: |
          pip install aws-sam-cli
      
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::701111311029:role/profile-photo-ai-dev-role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Build SAM application
        run: |
          echo "ðŸ“¦ Building SAM application..."
          sam build --parallel
      
      - name: Deploy to AWS
        run: |
          echo "ðŸš€ Deploying to AWS..."
          sam deploy \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --resolve-s3 \
            --s3-prefix profile-photo-ai-dev \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=${{ env.ENVIRONMENT }}
      
      - name: Get stack outputs
        id: stack-outputs
        run: |
          echo "ðŸ“‹ Fetching stack outputs..."
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
            --output text)
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "âœ… API Gateway URL: $API_URL"
      
      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          API_URL="${{ steps.stack-outputs.outputs.api_url }}"
          
          # Health check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "âœ… API is reachable"
          else
            echo "âš ï¸ API health check returned: $HTTP_CODE"
          fi
      
      - name: Comment PR with deployment info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const apiUrl = '${{ steps.stack-outputs.outputs.api_url }}';
            const comment = `## ðŸš€ Deployment to Dev Successful
            
            **Environment:** dev
            **Stack:** ${{ env.STACK_NAME }}
            **API Gateway URL:** ${apiUrl}
            
            ### Endpoints
            - POST \`${apiUrl}/upload\`
            - POST \`${apiUrl}/generate\`
            - GET \`${apiUrl}/user/me\`
            
            Deployed from commit: ${context.sha.substring(0, 7)}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  deploy-frontend:
    name: Deploy Frontend
    needs: deploy-backend
    runs-on: ubuntu-latest
    environment:
      name: development
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::701111311029:role/profile-photo-ai-dev-role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get backend configuration
        id: backend-config
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
            --output text)
          
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CognitoUserPoolId`].OutputValue' \
            --output text)
          
          CLIENT_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CognitoUserPoolClientId`].OutputValue' \
            --output text)
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT
          echo "client_id=$CLIENT_ID" >> $GITHUB_OUTPUT
      
      - name: Create .env file
        run: |
          cd frontend
          cat > .env.production << EOF
          REACT_APP_API_BASE_URL=${{ steps.backend-config.outputs.api_url }}
          REACT_APP_AWS_REGION=${{ env.AWS_REGION }}
          REACT_APP_USER_POOL_ID=${{ steps.backend-config.outputs.user_pool_id }}
          REACT_APP_USER_POOL_CLIENT_ID=${{ steps.backend-config.outputs.client_id }}
          EOF
          
          echo "âœ… Created .env.production"
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          CI: false
      
      - name: Deploy to S3
        run: |
          echo "ðŸ“¦ Deploying frontend to S3..."
          aws s3 sync frontend/build/ s3://profile-photo-ai-frontend-dev/ --delete
          echo "âœ… S3 sync completed"
      
      - name: Invalidate CloudFront cache
        run: |
          echo "ðŸ”„ Invalidating CloudFront cache..."
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)
          
          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
            echo "âœ… CloudFront cache invalidated"
          else
            echo "âš ï¸ CloudFront distribution not found, skipping cache invalidation"
          fi

  notify:
    name: Notify Deployment Status
    needs: [deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Discord notification
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ needs.deploy-backend.result }}"
          COLOR="3066993"  # Blue
          
          if [ "$STATUS" = "success" ]; then
            COLOR="3066993"  # Green
            EMOJI="âœ…"
          elif [ "$STATUS" = "failure" ]; then
            COLOR="15158332"  # Red
            EMOJI="âŒ"
          else
            COLOR="16776960"  # Yellow
            EMOJI="âš ï¸"
          fi
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$EMOJI Deployment to Dev\",
                \"description\": \"**Status:** $STATUS\n**Branch:** ${{ github.ref_name }}\n**Commit:** ${{ github.sha }}\",
                \"color\": $COLOR,
                \"footer\": {
                  \"text\": \"ProfilePhotoAI CI/CD\"
                }
              }]
            }" \
            $DISCORD_WEBHOOK_URL || echo "Discord notification skipped"
